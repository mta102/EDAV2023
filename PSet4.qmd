---
title: "Test"
server: shiny
---

```{r}
library(tidyverse)
```

```{r}
data = read.csv("covid.csv")

```

```{r}

#boxplot of sample size - conclusion - OK - weekly max ~21k (higher than spec but not sig out of line), monthly max ~90k

data |> filter(Time.Type == "Weekly") |> 
  ggplot(aes(Sample.Size)) +
  geom_boxplot(outlier.colour="black", outlier.shape=16) +
  ggtitle("boxplot") +
  labs(x = "sample size") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r}

#missing data analysis

data |> filter(Time.Type == "Weekly") |> mutate(missing_estimate = is.na(Estimate....)) |> 
  ggplot(aes(x = Sample.Size)) +
  geom_histogram(binwidth = 10) +
  ggtitle("x") +
  labs(x = "sample size", y = "freq") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) + 
  facet_wrap(~missing_estimate,scales = "free_y")


```

```{r}

#exploration

see_raw_data<-function(geography,time_period,year,group_name) {
output = data |> filter(Geography == geography,Indicator.Name=="Vaccination uptake and intention",Time.Period == time_period,Year == year, Group.Name==group_name) |> select(Group.Category,Indicator.Category,Estimate....,Sample.Size)
   return(output)
}


see_hesitance_summary<-function(geography,time_period,year,group_name,hesitant_group) {
output = data |> filter(Geography == geography,Indicator.Name=="Vaccination uptake and intention",Time.Period == time_period,Year == year, Group.Name==group_name)  |> mutate(hesitant = ifelse(Indicator.Category %in% hesitant_group,1,0)) |> group_by(Group.Category,hesitant) |> summarise(hesitance_rate = sum(Estimate....),sample_size = first(Sample.Size)) |> mutate(n_hesitance = round(hesitance_rate/100 * sample_size,0)) |> filter(hesitant == 1) |> select(Group.Category,hesitance_rate,n_hesitance,sample_size) 
   return(output)
}


get_chi_sq<-function(geography,time_period,year,group_name,hesitant_group) {
  
  temp = data |> filter(Geography == geography,Indicator.Name=="Vaccination uptake and intention",Time.Period == time_period,Year == year, Group.Name==group_name)  |> mutate(hesitant = ifelse(Indicator.Category %in% hesitant_group,1,0)) |> group_by(Group.Category,hesitant) |> summarise(hesitance_rate = sum(Estimate....),sample_size = first(Sample.Size)) |> mutate(n_hesitance = round(hesitance_rate/100 * sample_size,0)) |> filter(hesitant == 1) |> select(Group.Category,n_hesitance,sample_size) 
  
  expected_proportion = sum(temp$n_hesitance)/sum(temp$sample_size)

  temp = temp |> mutate(expected = sample_size*expected_proportion)
  
  res = chisq.test(x=temp$n_hesitance,p=temp$expected/sum(temp$expected))
   output<-list(res$statistic,res$p.value)
   return(output)
}

temp = see_raw_data(geography="National",time_period = "June 25 - June 30",year=2023,group_name="Age")


# 
temp2 = see_hesitance_summary(geography="National",time_period = "June 25 - June 30",year=2023,group_name="Age",hesitant_group = c("Probably or definitely will not get vaccinated"))

unique(data$Group.Name)

group_name_toloop = c("Sex","Age","Race/Ethnicity (7 level)")
result_df <- data.frame(matrix(ncol = 3, nrow = 0))
colnames(result_df) <- c("group_name", "X2_test_stat", "p_value")

for (x in group_name_toloop) {
  res = get_chi_sq(geography="National",time_period = "June 25 - June 30",year=2023,group_name=x,hesitant_group = c("Probably or definitely will not get vaccinated"))
  result_df[nrow(result_df) + 1,] = c(x,res[1],res[2])

}
result_df = arrange(result_df,desc(X2_test_stat))



```

```{r}

output = data |> filter(grepl("TX",Geography)|Geography=="Texas",Indicator.Category=="Unvaccinated",Time.Period == "April 22 - May 29",Year == 2021, Group.Name=="All adults 18+" ) |> select(Geography,Sample.Size)

```

```{r}
unique(data$Geography)









```
