# Results

#### Part 1: Study which segments of the population exhibited greatest covid vaccine hesitancy following the deployment of mass vaccinations in the US in early 2021. 

The national average reported covid hesitance rate during the first quarter of the data collection period (April - June 2021) was 17.7%.
```{r}

periods_to_combine_2021 = c("April 22 - May 29","May 30 - June 26","June 27 - July 31") 

national_hesitance_rate = covid%>% filter(`Year` == 2021, `Time Period` %in% periods_to_combine_2021, `Group Category`== "All adults age 18+ years", Geography == "National", `Indicator Category` == "Probably or definitely will not get vaccinated") %>% mutate(n_hesitant = round(`Estimate (%)`/100 * `Sample Size`,0)) %>% group_by(Geography) %>% summarise(`Sample Size` = sum(`Sample Size`), n_hesitant = sum(n_hesitant)) %>% mutate(`Estimate (%)` = n_hesitant / `Sample Size` * 100, `Time Period` = "2021 analysis period",Year = 2021) 

```

There were significant differences of hesitance by state during this period, from 7.9% in Hawaii, to 33.3% in Wyoming, as illustrated in the map below.

```{r}
covid_2021_analysis_allstates = covid%>% filter(`Year` == 2021, `Time Period` %in% periods_to_combine_2021, `Group Category`== "All adults age 18+ years", `Geography Type` %in% c("Jurisdictional Estimates"), `Indicator Category` == "Probably or definitely will not get vaccinated", !grepl("-",Geography)) %>% mutate(n_hesitant = round(`Estimate (%)`/100 * `Sample Size`,0)) %>% group_by(Geography) %>% summarise(`Sample Size` = sum(`Sample Size`), n_hesitant = sum(n_hesitant)) %>% mutate(`Estimate (%)` = n_hesitant / `Sample Size` * 100, `Time Period` = "2021 analysis period",Year = 2021) 

#Karl to add map code here, using covid_2021_analysis_allstates%`Estimate (%)` for heatmap

```

The histogram and boxplot below shows that there are no clear outliers, even though over 50% of states fall outside the 1st and 3rd quartile.

```{r}
ggplot(covid_2021_analysis_allstates, aes(x = `Estimate (%)`)) +
  geom_histogram(binwidth = 5, fill = "blue", color = "black", alpha = 0.7) +
  geom_boxplot() +
  labs(title = "State distribution of hesitance", x = "Hesitance %", y = "No. of states")

quartiles_1_3 = quantile(covid_2021_analysis_allstates$`Estimate (%)`, c(0.25, 0.75))
n_outside_IQR = sum(covid_2021_analysis_allstates$`Estimate (%)` < quartiles_1_3[1] | covid_2021_analysis_allstates$`Estimate (%)` > quartiles_1_3[2])/nrow(covid_2021_analysis_allstates) * 100
```

Nationally, it can be seen that the following 10 segments demonstrated the highest vaccine hesitance rates in the period in question.

```{r}


group_name_shortening <- c(
"Sex" = "Sex","Age" = "Age","Race/Ethnicity (7 level)" = "Race","Age by race/ethnicity" = "Age.Race","Sexual orientation" = "S.Orientation","Gender identity" = "G.Identity","Metropolitan statistical area" = "Rural.Urban","Born in the U.S." = "US.Born","Language of interview" = "Language","Poverty status" = "Pov.Status","Insurance status" = "Insurance","Social Vulnerability Index (SVI) of county of residence" = "SVI","Political leaning of county of residence" = "Political","Received non-COVID-19 vaccine(s) in past two years" = "Past.Vaccin","Health condition associated with higher risk for COVID-19 (any)" = "Comorbidity","Disability status (any)" = "Disability","Pregnancy status (females age 18 – 49 years)" = "Pregnancy","Ever had COVID-19 disease (self-report)" = "Past.Covid","Concern about getting COVID-19 disease" = "Covid.Concern","Confidence in COVID-19 vaccine safety" = "Vaccine.Confiden","Confidence that COVID-19 vaccine is important" = "Vaccine.Imprtnt","Healthcare provider recommended I get a COVID-19 vaccine" = "Dr.Recommend","COVID-19 vaccination status of friends and family" = "Fr.Fam.Vaccd","Work or school requires COVID-19 vaccination" = "Work.School"
)

group_cat_shortening = c("18 – 49 years" = "18 – 49","50 – 64 years" = "50 – 64","65+ years" = "65+","18 – 49 years, Black, non-Hispanic" = "18 – 49, Black","18 – 49 years, Hispanic" = "18 – 49, Hispanic","18 – 49 years, Other or multiple races, non-Hispanic" = "18 – 49, Other","18 – 49 years, White, non-Hispanic" = "18 – 49, White","50 – 64 years, Black, non-Hispanic" = "50 – 64, Black","50 – 64 years, Hispanic" = "50 – 64, Hispanic","50 – 64 years, Other or multiple races, non-Hispanic" = "50 – 64, Other","50 – 64 years, White, non-Hispanic" = "50 – 64, White","65+ years, Black, non-Hispanic" = "65+, Black","65+ years, Hispanic" = "65+, Hispanic","65+ years, Other or multiple races, non-Hispanic" = "65+, Other","65+ years, White, non-Hispanic" = "65+, White","Born in the U.S." = "US Born","Not born in the U.S." = "Not US Born","Many or almost all family or friends have received vaccine" = "Many","Some or no family or friends have been vaccinated" = "No_some","A little or not at all concerned" = "A little_not","Very or moderately concerned" = "Very_Moderately","Somewhat or not at all safe for me" = "Not at all_Somewhat","Very or completely safe for me" = "Very","A little or not at all important to protect me from COVID-19" = "A little_not at all","Somewhat or very important to protect me from COVID-19" = "Somewhat_very","No" = "No","Yes" = "Yes","Cisgender" = "Cisgender","Don't know/refused" = "Dont know","Transgender/Non-binary" = "TG/Non bin","Insured" = "Insured","Not insured" = "Not insured","English" = "English","Other" = "Other","Spanish" = "Spanish","Rural" = "Rural","Suburban" = "Suburban","Urban" = "Urban","Democrat-leaning" = "Democrat","Not Democrat-leaning or Republican-leaning" = "None","Republican-leaning" = "Republican","Above poverty, income <$75k" = "<$75k","Above poverty, income >=$75k" = ">=$75k","Below poverty" = "Below poverty","Unknown income" = "Unknown","Breastfeeding" = "Breastfeeding","Not pregnant, trying to get pregnant, or breastfeeding" = "Not pregnant","Pregnant" = "Pregnant","Trying to get pregnant" = "Trying to get pregnant","American Indian/Alaska Native, non-Hispanic" = "Native","Asian, non-Hispanic" = "Asian","Black, non-Hispanic" = "Black","Hispanic" = "Hispanic","Native Hawaiian/Pacific Islander, non-Hispanic" = "Pacific","Other or multiple races, non-Hispanic" = "Other","White, non-Hispanic" = "White","Female" = "Female","Male" = "Male","Gay/Lesbian/Bisexual/Other" = "LGB","Heterosexual/Straight" = "Hetero","High SVI" = "High","Low SVI" = "Low","Moderate SVI" = "Moderate","SVI unknown" = "Unknown","Not applicable/unemployed" = "Unemployed")


covid_2021_analysis = covid%>% filter(`Year` == 2021, `Time Period` %in% periods_to_combine_2021, `Group Name` %in% group_name_toloop, `Geography Type` %in% c("Jurisdictional Estimates","National Estimates"), `Indicator Category` == "Probably or definitely will not get vaccinated", !grepl("-",Geography)) %>% mutate(n_hesitant = round(`Estimate (%)`/100 * `Sample Size`,0)) %>% group_by(pick(c(1:6))) %>% summarise(`Sample Size` = sum(`Sample Size`), n_hesitant = sum(n_hesitant)) %>% filter(Geography == "National") %>% mutate(`Estimate (%)` = n_hesitant / `Sample Size` * 100, `Time Period` = "2021 analysis period",Year = 2021)

#shorten group names
covid_2021_analysis = covid_2021_analysis %>%
  mutate_at(vars(`Group Name`), ~recode(., !!!group_name_shortening))

covid_2021_analysis = covid_2021_analysis %>%
  mutate_at(vars(`Group Category`), ~recode(., !!!group_cat_shortening))

covid_2021_analysis = covid_2021_analysis %>% mutate(concat = paste(`Group Name`, `Group Category`, sep = " - "))

covid_2021_analysis$concat_wrap = str_wrap(covid_2021_analysis$concat, width = 10)

covid_2021_analysis %>% ungroup %>% top_n (10, `Estimate (%)`) %>% ggplot(aes(x = fct_reorder(concat_wrap,-(`Estimate (%)`)), y = `Estimate (%)`)) +  geom_bar(stat = "identity")+
labs(title = "Top 10 categories with the highest hesitance in 2021", x = "Group categories", y = "2021 hesitance (%)") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1,size=6),
        axis.text.y = element_text(size=8),
        axis.title = element_text(size = 8),
        plot.title = element_text(size = 12))

top_10_highest_hesitance_cat_list = c(covid_2021_analysis %>% ungroup %>% top_n (10, `Estimate (%)`) %>% select(concat))

```



Analysing 10 states with the highest and lowest hesitance, the parallel coordinate plots below will review geographical patterns in segments of the population with the highest hesitance.

#Karl to add parallel coordinate plots here and commentary using top_10_highest_hesitance_cat_list

Given the inconsistant trends seen across states and group categories with the highest hesitance, we proceeded to conduct a chi squared tests on every possible group name to determine those with the highest statistical significance.

```{r}

get_chi_sq<-function(df,geography,time_period,year,group_name,hesitant_group) {
  
  temp = df |> filter(Geography == geography,`Indicator Name`=="Vaccination uptake and intention", `Time Period` == time_period,Year == year, `Group Name`==group_name)  |> mutate(hesitant = ifelse(`Indicator Category` %in% hesitant_group,1,0)) |> group_by(`Group Category`,hesitant) |> summarise(hesitance_rate = sum(`Estimate (%)`),sample_size = first(`Sample Size`)) |> mutate(n_hesitance = round(hesitance_rate/100 * sample_size,0)) |> filter(hesitant == 1) |> select(`Group Category`,n_hesitance,sample_size) 
  if (nrow(temp) > 0) {
    expected_proportion = sum(temp$n_hesitance)/sum(temp$sample_size)

  temp = temp |> mutate(expected = sample_size*expected_proportion)
  
  res = chisq.test(x=temp$n_hesitance,p=temp$expected/sum(temp$expected))
   output<-list(round(res$statistic,digits = 0),res$p.value)
    
  }
  else {
    output<-list(0,0)
    
  }
  
  
   return(output)
}

group_name_toloop = c("Sex","Age","Race/Ethnicity (7 level)","Age by race/ethnicity","Sexual orientation","Gender identity","Metropolitan statistical area","Born in the U.S.", "Language of interview","Poverty status", "Insurance status","Social Vulnerability Index (SVI) of county of residence", "Political leaning of county of residence", "Received non-COVID-19 vaccine(s) in past two years", "Health condition associated with higher risk for COVID-19 (any)","Disability status (any)", "Pregnancy status (females age 18 – 49 years)", "Ever had COVID-19 disease (self-report)","Concern about getting COVID-19 disease", "Confidence in COVID-19 vaccine safety",  "Confidence that COVID-19 vaccine is important", "Healthcare provider recommended I get a COVID-19 vaccine",  "COVID-19 vaccination status of friends and family","Work or school requires COVID-19 vaccination" )

group_name_toloop_short = lapply(group_name_toloop, function(x) ifelse(x %in% names(group_name_shortening), group_name_shortening[[x]], x))
  

result_df2 <- data.frame(matrix(ncol = 3, nrow = 0))
colnames(result_df2) <- c("group_name", "X2_test_stat", "p_value")

for (x in group_name_toloop_short) {
  res = get_chi_sq(covid_2021_analysis,geography="National",time_period = "2021 analysis period",year=2021,group_name=x,hesitant_group = c("Probably or definitely will not get vaccinated"))
  result_df2[nrow(result_df2) + 1,] = c(x,res[1],res[2])

}
result_df2 = arrange(result_df2,desc(X2_test_stat))


```

The top 10 most statistically significant group names are shown below:

```{r}
result_df2 %>% ungroup %>% top_n(10,X2_test_stat)

```
Two illustrative mosaic plots are shown below to confirm the chi square test result above - one for the group name with the higest X2 score, and one for the lowest. 


```{r}

mosaic_2var <-function(df,indep_var_group_name,n_chars) {
  
  truncate_string <- function(x) {
  str_sub(x, 1, n_chars)}

indep_var_group_name_no_spaces = gsub("[()\\[/\\\\ ]", ".", indep_var_group_name)
indep_var_group_name_no_spaces = truncate_string(indep_var_group_name_no_spaces)

temp = df %>% ungroup %>% filter(`Group Name` == indep_var_group_name) %>% mutate(n_not_hesitant = `Sample Size` - n_hesitant) %>%  select(`Group Category`, n_hesitant, n_not_hesitant,`Sample Size`) %>%  rename(
    !!indep_var_group_name_no_spaces := `Group Category`,hesitant = `n_hesitant`, `not hesitant` = n_not_hesitant) %>% 
  pivot_longer(cols = hesitant:`not hesitant`,names_to = "group", values_to = "Freq" )

temp[[indep_var_group_name_no_spaces]] =  substr(temp[[indep_var_group_name_no_spaces]], 1, n_chars)

formula = as.formula(paste("group", "~", indep_var_group_name_no_spaces))

mosaic(formula, direction = c("v", "h"), temp,
       highlighting_fill = c("grey80", "cornflowerblue"),gp_varnames = gpar(fontsize = 10, fontface = 1), gp_labels = gpar(fontsize = 6))
return(temp)
}

mosaic_2var(covid_2021_analysis,"Vaccine.Imprtnt",100)

mosaic_2var(covid_2021_analysis,"G.Identity",100)


```
It can be clearly seen that those that saw a vaccine as important had significantly lower hesitance than those that did not - there is a significant difference between the observed and expected mosaic plots. However, for the group name with the lowest X2 score (gender identity), the observed and expected mosaic plots are nearly identical, thus confirming the X2 test result.

[add commentary on results]


#### Part 2: Analyze which segments showed the greatest reduction in covid vaccine hesitancy between 2021 and 2023



#### Part 3: Based on the findings above, we will propose high-level recommendations for segments of the population that need further public health interventions.

Provide a short nontechnical summary of the most revealing findings of your analysis written for a nontechnical audience. Take extra care to clean up your graphs, ensuring that best practices for presentation are followed, as described in the  audience ready style section  below.

Use subheadings (##) as appropriate. See  Todd Schneider’s blog posts  for examples of thoughtful, informative subheadings. An approach that works well is to create a subheading for each of your research questions.

The number of graphs will vary by project; we suggest a target of 10. (A plot with multiple facets counts as 1 graph).  If you go over, make sure they are high quality and include commentary.  A project with 10 good graphs plus commentary will receive a better grade than a project with 10 good graphs and 10 mediocre ones.
